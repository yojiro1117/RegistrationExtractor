# RegistrationExtractor

**RegistrationExtractor** は、日本の登記簿 PDF（不動産：土地・建物、法人登記）を解析し、現所有者情報を整理して Excel に出力するためのアプリケーションです。GUI と CLI の両方を提供し、複数ファイルの一括処理や共有者の分割出力、事故簿の判定など、登記情報の実務に必要な機能を備えています。

## 特長

- **GUI (Streamlit)**：ブラウザベースの直感的なインターフェイス。ドラッグ＆ドロップで複数の PDF をまとめて解析できます。OCR の ON/OFF トグル、出力先指定、進捗バー、実行ログなどを備えています。
- **CLI**：大量処理向けのコマンドラインインターフェイス。入力フォルダと出力ファイルを指定し、並列ワーカーでサブフォルダを含めた PDF を一括処理します。実行ログは `runlog.txt` に出力されます。
- **共有者の出力ルール**：1 名義人につき 1 行。共有者が複数いる場合、2 人目以降の行は共通列（所在・地番など）を空欄にし、氏名の前に持分（原文）を付けて出力します。
- **事故簿判定**：共有持分の小数合計が 1.0 にならない場合、「事故簿です」とフラグを立て、メモ欄に合計持分や判定根拠を記録します。事故簿であっても現所有者の記載は出力されます。
- **OCR は任意**：既定では OFF ですが、座標限定の OCR（pytesseract）を利用することで、地積や受付番号など読み取りが難しい項目を保険的に補完できます。

## 動作環境

- Windows 64bit（Python 3.11 前提）
- 外部ライブラリは `requirements.txt` に記載されています。PyInstaller で単一ファイルの実行形式にビルドできます。

## インストール

```bash
git clone <repository-url>
cd RegistrationExtractor
python -m venv .venv
source .venv/bin/activate  # Windows 環境では `.venv\Scripts\activate`
pip install -r requirements.txt
```

## GUI の使い方

1. ターミナルでプロジェクトルートに移動し、以下のコマンドを実行します。

   ```bash
   streamlit run app/gui.py
   ```

2. ブラウザが開いたら、解析したい PDF ファイルまたはフォルダをドラッグ＆ドロップします。
3. 必要に応じて OCR を有効にし、出力先ファイルを指定します。
4. 「実行」を押すと解析が始まり、進捗が表示されます。完了後に Excel ファイル (`owners.xlsx`) が生成されます。

## CLI の使い方

大量処理やバッチ処理には CLI を利用します。

```bash
python -m app.cli --input "C:\登記PDF" --output "C:\owners.xlsx" --enable-ocr --workers 6
```

オプション:

- `--input`：解析対象のフォルダまたはファイルを指定します。サブフォルダも再帰的に走査します。
- `--output`：出力先の Excel ファイルを指定します。
- `--enable-ocr`：OCR を有効にします（任意）。
- `--workers`：並列ワーカー数を指定します（デフォルト 4～8）。

## Excel 出力仕様

生成されるブックは 1 シート固定で、シート名は `所有者一覧(最新_一括)` です。列の順序は以下の通りです（抜粋）：

|列|説明|
|:---|:---|
|ファイル名|処理した PDF のファイル名|
|種別|土地/建物/法人|
|事故簿フラグ|合計持分≠1.0 の場合 TRUE|
|事故簿メモ|合計持分値や判定根拠のメモ|
|…|土地・建物・法人ごとの属性や、現権利者の持分・氏名・住所・原因日など多数|

共有者が複数いる場合は 1 名義人につき 1 行で、2 人目以降の行は共通項目を空欄とします。氏名の前には原文の持分を付けて出力します。

事故簿の場合、合計持分を計算して 1.0 にならない場合にフラグを立て、「事故簿です」と明示します。事故簿であっても現所有者の情報は出力されます。

## GitHub Actions でのビルド

`.github/workflows/release.yml` に定義されたワークフローにより、main ブランチへの push または GitHub Release 作成時に PyInstaller を使って Windows 用実行ファイルをビルドし、成果物 (`RegistrationExtractor.exe`) を自動でリリースに添付します。PyInstaller には必要なバイナリモジュール（cffi や cryptography など）を collect する設定が含まれています。

## 既知の制約

- スキャン PDF（画像のみ）の場合、テキスト抽出が困難なため OCR が必要です。
- サンプルにない特殊なレイアウトや外字フォントでは抽出精度が低下する可能性があります。
- OCR は保険的なものとして実装されており、全ての項目を完全に読み取れる保証はありません。

## 問題報告

バグや改善要望がありましたら、以下の情報を含めて Issue を作成してください。

- 問題が発生した PDF（個人情報や機微情報をマスキングしたもの）
- 再現手順
- 期待する結果と実際の結果

## スクリーンショット

GUI のスクリーンショット例です。実際の画面は環境やバージョンにより異なる場合があります。

![GUI Screenshot](./docs/screenshot.png)

このプロジェクトは MIT ライセンスの下で公開されています。詳細は `LICENSE` を参照してください。
